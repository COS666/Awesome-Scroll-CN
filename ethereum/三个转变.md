*特别感谢 Dan Finlay，Karl Floersch，David Hoffman 以及 Scroll 和SoulWallet 团队的反馈，审阅和建议。*

随着以太坊从最开始的实验性技术，过渡到能够为普通用户带来开放、全球化和无需许可体验的成熟堆栈。这需要经历大致上同时进行的三个主要技术转变：

- L2 扩容的转变 - 每个人都迁移至Rollups
- 钱包安全的转变 - 每个人都迁移至智能合约钱包
- 隐私的转变 - 确保隐私交易可用，并且其他正在开发的社交恢复，身份，声誉等工具都可以保护隐私

![](https://vitalik.eth.limo/images/three_transitions/triangle.png)

生态系统转变三角


如果没有第一个转变，以太坊就会失败，因为现在每笔交易的成本大致为 3.75 美元（如果我们再有一次牛市，就可能会变成 82.48 美元），因此每个针对大众市场的产品都不可避免地抛弃链本身，并对所有事情都采用中心化的解决方案。

如果没有第二个转变，以太坊也会失败，因为用户不愿意存储他们的资金（和非金融资产），每个人都将转移到中心化交易所。

如果没有第三个转变，以太坊仍然会失败，因为让所有交易（和POAP等）都公开可供任何人查看，这对许多用户来说所牺牲的隐私代价太高了，因此每个人都转向中心化的解决方案，至少在某种程度上它隐藏了你的数据。

由于上述原因，这三个转变至关重要。但是，它们也具有挑战性，因为需要密切协调才能妥善解决这些问题。需要改进的不仅仅是协议的功能；在某些情况下，我们与以太坊交互的方式需要从根本上改变，需要应用程序和钱包端的深度改变。

## 这三个转变将从根本上重塑用户和地址之间的关系。

在 L2 扩容世界中，用户将存在于许多 L2 上。如果你是构建在 Optimism上的ExampleDAO的一员，那么你将有一个Optimism的帐户！如果你在zkSync的稳定币系统中持有抵押债务的头寸，那么你将在zkSync上有一个帐户！如果你曾经碰巧去尝试过一些在Kakarot上的应用程序，那么你将在卡卡罗特上有一个帐户！用户只有一个地址的日子将一去不复返。

![](https://vitalik.eth.limo/images/three_transitions/braveview.png)

根据我的 Brave Wallet，我在四个地方都有ETH。是的，Arbitrum和Arbitrum Nova是不同的。随着时间的推移，它会变得更加混乱！

智能合约钱包增加了复杂性，使得L1和各种L2之间拥有相同的地址变得更加困难。今天，大多数用户都在使用外部帐户，其地址实际上是用于验证签名的公钥的哈希值，因此L1和L2之间没有任何变化。然而，使用智能合约钱包，保持一个地址变得更加困难。尽管已经有很多工作在尝试将地址变成跨链等效的代码哈希，其中最值得关注的是CREATE2和ERC-2470(Singleton Factory)，但很难完美地做到这一点。一些L2（例如“Type4 zkEVM”） 并不完全等价于 EVM，通常使用 Solidity 或中间层代替，使得没法实现相同的哈希。并且即使你可以拥有哈希等价性，当钱包通过更改密钥来改变所有权时，也会衍生出其他复杂的情况。

隐私要求每个用户拥有更多的地址，甚至可能改变我们正在处理的地址类型。如果隐私地址的提案被广泛采纳，用户可能每笔交易就有一个地址，而不是像上文提到的每个用户只有几个地址，或者每个L2有一个地址。其他隐私方案，甚至是现有的隐私方案，如Tornado Cash，也用不同的方式改变了资产的存储方式：许多用户的资金存储在同一个智能合约中（因此存储在同一个地址），要向特定用户发送资金，用户需要依靠隐私方案内部的寻址系统。

正如我们所看到的，这三个转变中的每一个都以不同的方式削弱了“一个用户~=一个地址”的心智模型，带来的影响反过来又提高了执行这些转变的复杂度，下面是两个具体的例子：

1.  如果你想向某人付款，你将如何获得有关付款的信息？
2. 如果用户将许多资产存储在不同链的不同位置，他们如何进行密钥更改和社交恢复？

## 三个转变和链上支付（和身份）

假设我在Scroll上有代币，想买一杯咖啡。你把咖啡卖给我，但你只设置了在Taiko上接收代币，怎么办？

基本上有两种解决方案：

1. 接收钱包（可能是商家，也可能只是普通个人）非常努力地支持每个L2，并具有一些异步归集资金的自动化功能。
2. 接收方提供他们的L2和他们的地址，发送方的钱包通过一些L2跨链桥系统自动将资金路由到目标L2。

当然，这些解决方案可以组合在一起：接收方提供他们愿意接受的L2列表，发送方的钱包将计算付款路径，如果幸运的话，将直接发送，或者是通过L2跨链桥的方式。

但这只是三个转变带来的关键挑战中的一个例子：像付款这样的简单行为，就开始需要比20个字节的地址更多的信息。

幸运的是，过渡到智能合约钱包对寻址系统来说并不是一个很大的负担，但在应用程序堆栈的其他部分仍然存在一些技术问题需要解决。钱包需要更新，以确保它们不会在交易中仅发送 21000 的gas，更重要的是确保钱包的接收方不仅需要追踪来自外部账户的 ETH 转账，还要追踪智能合约代码发送的 ETH。依赖于地址所有权不可变假设的应用（例如禁止智能合约强制执行版税的 NFT） 将不得不寻找其他方式来实现其目标。但智能合约钱包也会让一些事情变得更容易——值得注意的是，如果有人只收到一个非 ETH 的ERC20 代币，他们将能够使用 ERC-4337(Paymasters) 来使用该代币支付 gas。


另一方面，隐私再次引出了我们尚未真正解决的重大挑战。最初的Tornado Cash没有引入任何问题，因为它不支持内部转账：用户只能存入系统并从中提款。但是，一旦您可以进行内部转账，用户将需要使用隐私系统的内部寻址方案。在实现中，用户的“支付信息”需要同时包含（i）某种“支出公钥(Spending Pubkey)”，即对接收方可用来支出的秘密的承诺，以及（ii）发送方发送只有接收方才能解密的加密信息，以帮助接收方发现付款。

隐私地址协议依赖于元地址的概念，元地址是按如下的方式工作：元地址的一部分是发送方支出密钥的盲版(blinded version)，另一部分是发送方的加密密钥（尽管最小实现里可以将这两个密钥设置为相同的）。


![](https://vitalik.eth.limo/images/three_transitions/zk_stealth.png)

基于加密和ZK-SNARKs的抽象隐私地址方案示意图


这里的一个关键是，在一个隐私友好的生态系统中，用户将同时拥有支出公钥和加密公钥，用户的“支付信息”必须包含这两个密钥。除了支付之外，还有其他充分的理由使我们朝这个方向发展。例如，如果我们想要有基于以太坊的加密电子邮件，用户将需要公开提供某种加密密钥。在“外部账户世界”中，我们可以重用帐户公钥，但在安全的智能合约钱包世界中，我们可能应该为此提供更明确的功能。这也将有助于使基于以太坊的身份与非以太坊去中心化隐私生态系统更加兼容，尤其是PGP密钥。

##  三个转变和密钥恢复

在单用户多地址的世界中实现密钥更改和社交恢复的默认方法是，让用户分别在每个地址上运行恢复过程。这可以通过单击完成：钱包可以运行软件，同时在用户的所有地址上执行恢复过程。但是，即使在用户体验端进行了这样的简化，简单的多地址恢复也存在三个问题：

1. Gas成本将变得十分夸张：这是不言自明的。
2. 非实际地址(Counterfactual addresses): 智能合约尚未发布的地址（意味着你尚未从中发送资金）。作为用户，你可能拥有无限数量的非实际地址：每个L2上有一个或多个，包括还不存在的L2，以及由隐私地址方案产生的其他无限组非实际地址。
3. 隐私：如果用户故意使用许多地址来避免将他们的关联性暴露，他们当然不希望通过同时或几乎同时恢复它们来公开所有地址之间的联系！

解决这些问题很困难。幸运的是，有一个相对优雅的解决方案，性能也相当不错：一个将验证逻辑和资产持有分开的架构。

  

![](https://vitalik.eth.limo/images/three_transitions/keystore.png)


每个用户都有一个密钥库合约，该合约存在于一个位置（可以是主网或特定的 L2）。然后，用户在不同的 L2 上拥有地址，其中每个地址的验证逻辑是指向密钥库合约的一个指针。这些地址的支出需要向密钥库合约提交证明，显示当前（或者更准确的说，最近的）支出公钥。

该证明可以通过几种方式实现：

- **在 L2 内部直接进行 L1 的只读访问。** 可以修改 L2 来使它们直接读取 L1 状态。如果密钥库合约位于 L1 上，这意味着 L2 中的合约可以“自由”访问密钥库。
- **默克尔树分支。** 默克尔树分支可以将向 L2 证明 L1 的状态，或向 L1 证明 L2 状态，或者您可以将两者结合起来以向一个 L2 证明另一个 L2 的部分状态。Merkle 证明的主要缺点是由于证明长度而导致的高 gas 成本：证明可能大小为 5 KB，但未来使用 Verkle 树后，这将减少到1 KB以下。
- **ZK-SNARKs**. 可以通过使用默克尔树分支的 ZK-SNARK 证明而不是分支本身来降低数据成本。可以构建链下聚合技术（例如，在 EIP-4337 之上），让一个 ZK-SNARK 验证一个块中的所有跨链状态证明。
- **KZG承诺**。无论是L2s，还是建立在它们之上的方案，都可以引入一个顺序寻址系统，允许该系统内的状态证明只有48字节长。与ZK-SNARKs一样，多重证明方案可以将所有这些证明合并为每个块的单个证明。

  

![](https://vitalik.eth.limo/images/three_transitions/proofs.png)

如果我们想避免为每个交易生成一个证明，我们可以实现一个更轻量化的方案，只需要一个交叉L2证明即可恢复。来自帐户的支出将取决于支出密钥，其相应的公钥存储在该帐户中，但恢复需要发起一笔交易，来复制密钥库中当前的 `spending_pubkey` 。即使您的旧密钥不再安全，非实际地址中的资金也是安全的：“激活”非实际地址以将其变成工作的合约，需要生成交叉 L2 证明来复制当前的 `spending_pubkey` 。Safe论坛上的该帖子描述了类似结构的工作方式：[How can a Safe hold asset on multiple chains? - Safe Development / Contracts - Safe Community Forum](https://forum.safe.global/t/how-can-a-safe-hold-asset-on-multiple-chains/2242)

为了给这样的方案增加隐私，那么我们只需加密指针，并在ZK-SNARKs中进行所有证明：

![](https://vitalik.eth.limo/images/three_transitions/zk_keystore.png)

通过更多的工作，我们还可以抛开ZK-SNARKs的大部分复杂性，并制定一个更基础的基于KZG的方案。

这些方案可能会变得比较复杂。从好的方面来说，它们之间有许多潜在的协同效应。例如，“密钥库合约”的概念也可以解决上一节中提到的“地址”挑战：如果我们希望用户拥有不变的地址，并且每次用户更新密钥时都不会更改，我们可以将隐形元地址、加密密钥和其他信息放入密钥库合约中，并使用密钥库合约的地址作为用户的“地址”。

## 许多辅助基础设施需要更新

使用 ENS 的成本一向来很高。但在现在 2023 年 6 月，还不至于那么糟糕：交易费用很高，但至少大致上与 ENS 域名费用相当。注册zuzalu.eth花了我大约27美元，其中11美元是交易费。但如果再来一次牛市，费用就会飙升。即使没有ETH价格上涨，回到200 gwei的gas费用也会将域名注册的交易费用提高到104美元。因此，如果我们希望人们实际使用 ENS，特别是对于像去中心化社交媒体这样的用例，用户需要接近免费注册（ENS 域名费不是问题，因为这些平台往往为用户提供了子域名），我们需要 ENS 在 L2 也可以使用。

幸运的是，ENS 团队已经站出来了，ENS 正在 L2 上发生！ERC-3668（又名“CCIP标准”）与ENSIP-10一起，提供了一种使任何L2上的ENS子域名可以自动验证的方法。CCIP标准要求设置一个智能合约，其中包含一个验证L2数据的方法，并且可以控制一个域名（例如Optinames 使用了 `ecc.eth` ） 。一旦CCIP合约控制了L1上的 `ecc.eth` ，访问一些子域名将自动查找和验证在 L2 中实际存储了该特定子域的状态证明（例如默克尔树分支）。

![](https://vitalik.eth.limo/images/three_transitions/ccip.png)


获取证明需要访问存储在合约中的 URL 列表，这确实感觉像是中心化的。但我认为它实际上不是：这是一个 1 / N 的信任模型（无效证明会被 CCIP 合约回调函数中的验证逻辑所捕获，而且只要其中一个 URL 返回有效证明），而URL 列表中可能包含数十个。

ENS CCIP是一个成功的例子，它应该被视为一个信号，表明我们所需的激进变革实际上是可能的。但是，还有更多的应用层变革需要完成。举几个例子：

- 许多dapp依赖于用户提供链下签名。使用外部帐户很容易。而ERC-1271为智能合约钱包提供了一种标准化的方法。但是，许多dapp仍然不支持ERC-1271，他们未来将需要这样做。
- 根据外部账户来区分用户和合约的Dapps（例如防止转账或执行版税）将不再适用。总的来说，我建议不要试图在这个方面找到纯粹的技术解决方案；弄清楚加密控制权的特定转移，是否是受益权的转移是一个难题，如果不解决一些社区驱动的链下机制，可能无法解决。最有可能的是，应用程序将不得不减少对阻止转账技术的依赖，而更多地依赖于哈伯格税 (Harberger tax)等技术。
- 钱包与支出密钥和加密密钥的交互方式必须得到改进。目前，钱包通常使用确定性签名来生成特定于应用程序的密钥：使用外部账户的私钥对标准随机数（例如应用程序名称的哈希值）进行签名会生成一个确定性值，如果没有私钥就无法生成，因此它在纯技术意义上是安全的。但是，这些技术对钱包来说是“不透明的”，阻止了钱包在用户界面级别实现安全检查。在更成熟的生态系统中，签名、加密和相关功能将不得不由钱包更明确地处理。
- 轻客户端（例如Helios）将不得不验证L2，而不仅仅是L1。如今，轻客户端专注于校验 L1 区块头的有效性（使用轻客户端同步协议），并验证 L1 状态的默克尔树分支和 L1 区块头的交易。未来，他们还需要验证存储在L1状态根中的L2状态证明（更高级的版本实际上会验证L2的预确认）。

## 钱包需要同时保护资产和数据

今天，钱包在做着保护资产的业务。一切都存在于链上，钱包唯一需要保护的是当前保护这些资产的私钥。如果你更改了密钥，就可以在第二天安全地在互联网上发布以前的私钥。然而，在ZK的世界里，将不再是这样：钱包不仅保护身份验证凭据，还保存你的数据。

Zupass是在Zuzalu使用的基于ZK-SNARK的身份系统，我们看到了在Zupass上的这样一个世界。用户有一个私钥，他们用来向系统进行身份验证，可以用来制作基本证明，如“证明我是Zuzalu居民，而不透露是哪一个”。但是Zupass系统也出现了在其之上构建的其他应用程序，最著名的是邮票（Zupass的POAP版本）。


![](https://vitalik.eth.limo/images/three_transitions/zupass.png)

*我的众多Zupass邮票之一，证明了我是Team Cat的一员。*


邮票相对于POAP而言，提供了隐私的特性：您在本地保存数据，并且如果您希望某人拥有有关您的信息，则只能提供邮票的零知识证明（或对邮票进行一些计算）。但这会带来额外的风险：如果你丢失了这些信息，你就失去了你的邮票。

当然，保存数据的问题可以简化为持有单个加密密钥的问题：某些第三方（甚至链）可以保存数据的加密副本。这样的优点是方便，您执行的操作不会更改加密密钥，因此不需要与保护加密密钥安全的系统进行任何交互。但即便如此，如果你丢失了加密密钥，你也会失去一切。另一方面，如果有人看到了你的加密密钥，他们会看到加密的所有内容。

Zupass的解决方案是鼓励人们将密钥存储在多个设备（例如笔记本电脑和手机）上，因为他们同时无法访问所有设备的可能性很小。我们可以更进一步，使用秘密共享来存储密钥，在多个守护者之间分配。

通过MPC进行社交恢复对于钱包来说，并不是一个足够安全的解决方案，因为这意味着不仅现在的守护者，还有以前的守护者都有可能串通窃取你的资产，这样的高风险是无法接受的。但是，隐私泄露的风险通常低于总资产损失，并且具有高隐私用例需求的人，总是可以通过不备份与这些隐私需求的操作相关密钥，来接受更高的丢失风险。

为了避免用户被多个恢复路径的拜占庭式系统所困扰，支持社交恢复的钱包可能需要同时管理资产恢复和加密密钥恢复。

## 回到身份本身

这些转变的共同点之一是“地址”的概念，即你用来在链上表示“你”的加密标识符，将不得不从根本上改变。应用的交互说明，将不再仅仅是一个ETH地址；在某种形式上，它们可能是多个L2上的多个地址，隐私元地址，加密密钥和其他数据的某种组合。


一种方法是使 ENS 成为您的身份：您的 ENS 记录可以只包含所有这些信息。如果你向某人发送 `bob.eth` （或 `bob.ecc.eth` ，或...），他们可以查找并查看有关与你互动和支付的所有内容，包括更复杂的跨域和隐私保护方式。

但是这种以 ENS 为中心的方案有两个缺点：

-  它把太多的东西与你的名字绑定在一起。你的名字不是你，你的名字只是你的众多属性之一。你应该可以更改你的名字，而无需移动整个身份配置文件，并在许多应用程序上更新一大堆记录。
- 你不能拥有无需信任的非实际名称。任何区块链的一个关键用户体验功能是能够将代笔发送给尚未与链交互的人。如果没有这样的功能，就会陷入左右为难的境地：与链交互需要支付交易费用，这又需要已经有代币了。ETH地址，包括CREATE2的智能合约地址，具有此功能。ENS 名称没有，因为如果两个 Bob 都在链下决定他们是 `bob.ecc.eth` ，就无法选择其中哪一个获得该名称。

一种可能的解决方案是将更多内容放入前文架构中所提到的密钥库合约中。密钥库合约可能包含有关您的所有各种信息以及如何与你交互（使用 CCIP时，其中一些信息可能是链下的），用户将使用他们的密钥库合约作为他们的主要身份标识符。但是他们收到的实际资产将存储在各种不同的地方。密钥库合约不与名称绑定，因此它也可以是非实际存在的：你可以生成一个地址，该地址只能由具有某些固定初始参数的密钥库合约初始化。

另一类解决方案是完全摒弃面向用户的地址概念，其理念与比特币支付协议类似。一个想法是更多地依赖发送方和接收方之间的直接通信渠道；例如，发送方可以发送认领链接（可以为显式的 URL 或二维码），接收方可以使用该链接来用他们所希望的方式接受付款。

![](https://vitalik.eth.limo/images/three_transitions/claim.png)


无论发送方还是接受方首先采取行动，更多地依赖于钱包直接实时生成最新支付信息可以减少摩擦。也就是说，不变的身份标识符很方便（尤其是对于ENS而言），并且假设发送方和接收方之间的直接通信在实践中是一个非常棘手的问题，因此我们最终可能会看到不同技术的组合。

在所有这些设计中，保持去中心化和用户友好至关重要。我们需要确保用户可以在页面内能够轻松访问其当前最新的资产，以及指向他们的已发布消息。这些页面视图应该依赖于开源工具，而不是专有的解决方案。要避免支付基础设施的复杂性增加从而变成不透明的“抽象塔”，使开发者很难理解正在发生的事情并适应新的环境。尽管面临挑战，但为普通用户实现可扩展性、钱包安全和隐私，对于以太坊的未来至关重要。这不仅关乎技术可行性，还关乎普通用户的实际易访问性。我们需要挺身而出迎接这一挑战。